name: Service Chaining Policy
description: First template set - Create a Service Chaining Policy on a Domain
template-version: 1.0
software-type: Nuage Networks VSD
software-version: 5.0.2
variables:
  - name: enterprise_name
    type: reference
  - name: domain_name
    type: reference
  - name: chaining_policy_name
    type: string
  - name: policy_priority
    type: integer
  - name: active
    type: boolean
  - name: description
    type: string
    optional: true
  - name: endpoint_type
    type: choice
    choices:
      - l3
      - none
      - nsg_vnf
      - virtual_wire
  - name: location_type
    type: choice
    choices:
      - any
      - subnet
      - zone
  - name: location_name
    type: reference
    optional: true
  - name: zone_name
    type: reference
    optional: true
  - name: network_type
    type: choice
    choices:
      - any
      - subnet
      - zone
  - name: network_name
    type: reference
  - name: entry_priority
    type: integer
  - name: protocol
    type: string
  - name: source_port
    type: string
  - name: destination_port
    type: string
  - name: ether_type
    type: string
    optional: true
    default: "0x0800"
  - name: dscp
    type: string
    optional: true
    default: "*"
  - name: action
    type: choice
    choices:
      - forward
      - drop
  - name: flow_logging_enabled
    type: boolean
  - name: stats_logging_enabled
    type: boolean

actions:
  - select-object:
      type: Enterprise
      by-field: name
      value: {{ enterprise_name }}
      actions:
        - select-object:
            type: Domain
            by-field: name
            value: {{ domain_name }}
            actions:
              {% if location_type != 'any' %}
              {% if location_type == 'zone' %}
              - select-object:
                  type: Zone
                  by-field: name
                  value: {{ location_name }}
                  actions:
                    - store-value:
                        as-name: location_id
                        from-field: id
              {% endif %}
              {% if location_type == 'subnet' %}
              - select-object:
                  type: Zone
                  by-field: name
                  value: {{ zone_name }}
                  actions:
                    - select-object:
                        type: Subnet
                        by-field: name
                        value: {{ location_name }}
                        actions:
                          - store-value:
                              as-name: location_id
                              from-field: id
              {% endif %}
              {% endif %}
              {% if network_type != 'any' %}
              {% if network_type == 'zone' %}
              - select-object:
                  type: Zone
                  by-field: name
                  value: {{ network_name }}
                  actions:
                    - store-value:
                        as-name: network_id
                        from-field: id
              {% endif %}
              {% if network_type == 'subnet' %}
              - select-object:
                  type: Zone
                  by-field: name
                  value: {{ zone_name }}
                  actions:
                    - select-object:
                        type: Subnet
                        by-field: name
                        value: {{ network_name }}
                        actions:
                          - store-value:
                              as-name: network_id
                              from-field: id
              {% endif %}
              {% endif %}
              - create-object:
                  type: RedirectionTarget
                  actions:
                    - set-values:
                        name: {% set concat = "target_" + chaining_policy_name | default("") %}{{ concat }}
                        description: {{ description | default("RedirectionTarget target_" + chaining_policy_name | default("")) }}
                        endPointType: {{ endpoint_type | upper }}
              - create-object:
                  type: IngressAdvFwdTemplate
                  actions:
                    - set-values:
                        name: {{ chaining_policy_name }}
                        active: {{ active }}
                        priority: {{ policy_priority }}
                        description: {{ description | default("IngressAdvFwdTemplate " + chaining_policy_name | default("")) }}
                    - create-object:
                        type: IngressAdvFwdEntryTemplate
                        actions:
                          - set-values:
                              description: {{ description  | default("IngressAdvFwdEntryTemplate Entry_" + chaining_policy_name | default("")) }}
                              priority: {{ entry_priority }}
                              protocol: {{ protocol }}
                              {% if dscp is undefined %}
                              DSCP: '*'
                              {% else %}
                              DSCP: {{ dscp }}
                              {% endif %}
                              sourcePort: {{ source_port }}
                              destinationPort: {{ destination_port }}
                              etherType: {{ ether_type | default("0x0800") }}
                              action: {{ action | upper }}
                              flowLoggingEnabled: {{ flow_logging_enabled }}
                              statsLoggingEnabled: {{ stats_logging_enabled }}
                              locationType: {{ location_type | upper }}
                              networkType: {{ network_type | upper }}
                          {% if location_type == 'any' %}
                          - set-values:
                              locationID: ""
                          {% else %}
                          - retrieve-value:
                              from-name: location_id
                              to-field: locationID
                          {% endif %}
                          {% if network_type == 'any' %}
                          - set-values:
                              networkID: ""
                          {% else %}
                          - retrieve-value:
                              from-name: network_id
                              to-field: networkID
                          {% endif %}
