name: AccessPort
description: NSG template set - Create an access port
template-version: 1.0
software-type: Nuage Networks VSD
software-version: 5.1.1
variables:
  - name: nsg_name
    type: reference
  - name: access_port_name
    type: string
  - name: description
    type: string
    optional: true
  - name: physical_name
    type: string
  - name: speed
    type: choice
    choices: ["AUTONEGOTIATE", "BASET10", "BASET1000", "BASETX100", "BASEX10G"]
    optional: true
  - name: mtu
    type: integer
    optional: true
  - name: vlan_range
    type: string
    optional: true
  - name: vlan_value_list
    type: list
    item-type: integer
    optional: true
  - name: ingress_qos_policy_names
    type: list
    item-type: reference
    optional: true
  - name: egress_qos_policy_names
    type: list
    item-type: reference
    optional: true

actions:
  {% if egress_qos_policy_names | default([]) | length > 0 %}
  {% for vlan_value in vlan_value_list %}
  {% if ingress_qos_policy_names[loop.index - 1] != '' %}
  - select-object:
      type: IngressQOSPolicy
      by-field: name
      value: {{ ingress_qos_policy_names[loop.index - 1] }}
      actions:
        - store-value:
            as-name: {% set concat = "ingress_qos_policy_id_" + loop.index | string %}{{ concat }}
            from-field: id
  {% endif %}
  {% if egress_qos_policy_names[loop.index - 1] != '' %}
  - select-object:
      type: EgressQOSPolicy
      by-field: name
      value: {{ egress_qos_policy_names[loop.index - 1] }}
      actions:
        - store-value:
            as-name: {% set concat = "egress_qos_policy_id_" + loop.index | string %}{{ concat }}
            from-field: id
  {% endif %}
  {% endfor %}
  {% endif %}
  - select-object:
      type: NSGatewayTemplate
      by-field: name
      value: {{ nsg_name }}
      actions:
        - create-object:
            type: NSPortTemplate
            actions:
              - set-values:
                  name: {{ access_port_name }}
                  description: {{ description | default("Access Port " + access_port_name | default("")) }}
                  portType: ACCESS
                  physicalName: {{ physical_name }}
                  speed: {{ speed | default("AUTONEGOTIATE") | upper }}
                  mtu: {{ mtu | default(1500) }}
                  VLANRange: {{ vlan_range | default("0-4094") }}
              {% if egress_qos_policy_names | default([]) | length > 0 %}
              {% for vlan_value in vlan_value_list %}
              - create-object:
                  type: VlanTemplate
                  actions:
                    - set-values:
                        description: {{ description | default("Access Port " + access_port_name | default("")) }}
                        value: {{ vlan_value }}
                    {% if ingress_qos_policy_names[loop.index - 1] != '' %}
                    - retrieve-value:
                        from-name: {% set concat = "ingress_qos_policy_id_" + loop.index | string %}{{ concat }}
                        to-field: associatedIngressQOSPolicyID
                    {% endif %}
                    {% if egress_qos_policy_names[loop.index - 1] != '' %}
                    - retrieve-value:
                        from-name: {% set concat = "egress_qos_policy_id_" + loop.index | string %}{{ concat }}
                        to-field: associatedEgressQOSPolicyID
                    {% endif %}
              {% endfor %}
              {% endif %}
