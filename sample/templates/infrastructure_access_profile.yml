name: InfrastructureAccessProfile
description: NSG template set - Create an Infrastructure Access Profile
template-version: 1.0
software-type: Nuage Networks VSD
software-version: 5.1.1
variables:
  - name: infrastructure_access_profile_name
    type: string
  - name: description
    type: string
    optional: true
  - name: ssh_auth_mode
    type: choice
    choices: ["KEY_BASED", "PASSWORD_AND_KEY_BASED", "PASSWORD_BASED"]
  - name: user_name
    type: string
    optional: true
  - name: password
    type: string
    optional: true
  - name: source_ip_filters
    type: list
    item-type: string
    optional: true
  - name: ssh_key_names
    type: list
    item-type: string
    optional: true
  - name: ssh_keys
    type: list
    item-type: string
    optional: true

actions:
  - create-object:
      type: InfrastructureAccessProfile
      actions:
        - set-values:
            name: {{ infrastructure_access_profile_name }}
            description: {{ description | default("Infrastructure Access Profile " + infrastructure_access_profile_name | default("")) }}
            SSHAuthMode: {{ ssh_auth_mode | upper }}
            {% if ssh_auth_mode | upper == "PASSWORD_AND_KEY_BASED" or ssh_auth_mode | upper == "PASSWORD_BASED" %}
            userName: {{ user_name }}
            password: {{ password }}
            {% endif %}
        {% if source_ip_filters | default([]) | length > 0 %}
            sourceIPFilter: ENABLED
        {% for address in source_ip_filters %}
        - create-object:
            type: Connectionendpoint
            actions:
              - set-values:
                  name: {% set concat = infrastructure_access_profile_name + "_" + loop.index | string %}{{ concat }}
                  IPAddress: {{ address }}
        {% endfor %}
        {% else %}
            sourceIPFilter: DISABLED
        {% endif %}
        {% if ssh_auth_mode | upper == "PASSWORD_AND_KEY_BASED" or ssh_auth_mode | upper == "KEY_BASED" %}
        {% for name in ssh_key_names %}
        - create-object:
            type: SSHKey
            actions:
              - set-values:
                  name: {{ name }}
                  publicKey: {{ ssh_keys[loop.index - 1] }}
        {% endfor %}
        {% endif %}
